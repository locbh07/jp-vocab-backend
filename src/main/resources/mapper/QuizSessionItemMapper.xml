<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jpvocab.vocabsite.mapper.QuizSessionItemMapper">

  <resultMap id="QuizWordDtoMap" type="com.jpvocab.vocabsite.model.QuizWordDto">
    <result property="wordId" column="word_id"/>
    <result property="surface" column="surface"/>
    <result property="reading" column="reading"/>
    <result property="meaning" column="meaning"/>
  </resultMap>

  <select id="getItemsBySessionId" resultMap="QuizWordDtoMap">
    SELECT
      qsi.vocab_id AS word_id,
      v.word_ja AS surface,
      v.word_hira_kana AS reading,
      v.word_vi AS meaning
    FROM quiz_session_item qsi
    JOIN vocabulary v ON v.id = qsi.vocab_id
    WHERE qsi.session_id = #{sessionId}
    ORDER BY qsi.item_order ASC
  </select>

  <select id="getNextQuizItems" resultMap="QuizWordDtoMap">
    SELECT
      p.vocab_id AS word_id,
      v.word_ja AS surface,
      v.word_hira_kana AS reading,
      v.word_vi AS meaning
    FROM user_vocab_progress p
    JOIN vocabulary v ON v.id = p.vocab_id
    WHERE p.user_id = #{userId}
      AND p.vocab_id NOT IN (
        SELECT qsi.vocab_id
        FROM quiz_session_item qsi
        JOIN quiz_session qs ON qs.id = qsi.session_id
        WHERE qs.user_id = #{userId}
          AND qs.session_date = #{today}
      )
    ORDER BY p.last_reviewed_at DESC NULLS LAST, p.vocab_id ASC
    LIMIT #{limit}
  </select>

  <insert id="insertItems">
    INSERT INTO quiz_session_item
      (session_id, vocab_id, item_order, created_at)
    VALUES
    <foreach collection="items" item="item" separator=",">
      (#{item.session_id}, #{item.vocab_id}, #{item.item_order}, #{item.created_at})
    </foreach>
  </insert>

</mapper>
